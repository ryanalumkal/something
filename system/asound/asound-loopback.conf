# ALSA configuration for LeLamp with Audio Processing Loopback
#
# Architecture:
#   Real Mic → lelamp_capture_raw → AudioRouter → Loopback → lelamp_capture → LiveKit
#
# The AudioRouter service:
#   1. Captures from lelamp_capture_raw (real hardware)
#   2. Processes audio (gating during playback, optional AEC)
#   3. Writes to loopback_sink (hw:Loopback,0,0)
#
# Applications (LiveKit) capture from:
#   lelamp_capture → loopback_source (hw:Loopback,1,0)
#
# This allows us to gate/process audio before it reaches the AI.

# ==============================================================================
# SYSTEM DEFAULTS
# ==============================================================================

pcm.!default {
    type asym
    playback.pcm "lelamp_playback"
    capture.pcm "lelamp_capture"
}

ctl.!default {
    type hw
    card Device
}

# ==============================================================================
# ABSTRACT DEVICE LAYER - Applications use these
# ==============================================================================

# lelamp_playback - Abstract playback device (unchanged)
pcm.lelamp_playback {
    type plug
    slave.pcm "hw_playback_dmix"
}

# lelamp_capture - NOW ROUTES THROUGH LOOPBACK (processed audio)
# Applications using this get our gated/processed audio
pcm.lelamp_capture {
    type plug
    slave.pcm "loopback_source"
    hint {
        show on
        description "LeLamp processed mic input (via AudioRouter)"
    }
}

# lelamp_capture_raw - Direct hardware access for AudioRouter
# Only the AudioRouter should use this
pcm.lelamp_capture_raw {
    type plug
    slave.pcm "hw_capture_dsnoop"
    hint {
        show on
        description "LeLamp raw mic input (hardware direct)"
    }
}

# ==============================================================================
# LOOPBACK LAYER - Virtual audio routing
# ==============================================================================

# Loopback sink - AudioRouter WRITES processed audio here
pcm.loopback_sink {
    type plug
    slave {
        pcm {
            type hw
            card Loopback
            device 0
            subdevice 0
        }
        rate 24000
        format S16_LE
        channels 1
    }
}

# Loopback source - Applications READ processed audio from here
pcm.loopback_source {
    type plug
    slave {
        pcm {
            type hw
            card Loopback
            device 1
            subdevice 0
        }
        rate 24000
        format S16_LE
        channels 1
    }
}

# ==============================================================================
# HARDWARE LAYER - Physical devices
# ==============================================================================

# Hardware playback - USB with dmix for sharing
pcm.hw_playback_dmix {
    type dmix
    ipc_key 1024
    ipc_perm 0666
    slave {
        pcm {
            type hw
            card Device
            device 0
        }
        rate 48000
        format S16_LE
        channels 2
        period_time 0
        period_size 2048
        buffer_size 8192
    }
    bindings {
        0 0
        1 1
    }
}

# Hardware capture - Innomaker camera mic with dsnoop
pcm.hw_capture_dsnoop {
    type dsnoop
    ipc_key 1025
    ipc_perm 0666
    slave {
        pcm {
            type hw
            card InnomakerU20CAM
            device 0
        }
        rate 24000
        format S16_LE
        channels 2
        period_size 1024
        buffer_size 4096
    }
    bindings {
        0 0
        1 1
    }
}
